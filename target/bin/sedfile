#!/bin/bash

# Wrapper for 'sed -i': fail if file was not modified by sed and container was not restarted.
# Error output is surpressed, when container is restarted to avoid harmless error messages.
# Use "--strict" as first parameter, to fail regardless of the container state (fresh or restarted).

# When to use sedfile?
# Is a file change optional? --> use regular 'sed -i'
# Is a file change expected? --> use 'sedfile --strict -i'
# Is a file change only on the first container run expected? --> use 'sedfile -i'

set -ueo pipefail

HASHTOOL='sha1sum'
SKIP_ERROR=false

if [[ $# -lt 3 ]]
then
  echo 'At least three parameters must be given'
  echo -e "Usage: ${0} -i <replace/delete operation> <file>\n"
  exit 1
fi >&2

[[ -f /CONTAINER_START ]] && SKIP_ERROR=true # hide error if container was restarted
if [[ ${1} == '--strict' ]]                  # show error every time
then
  SKIP_ERROR=false
  shift
fi

# get last argument
FILE=${*: -1}

OLD="$(${HASHTOOL} "${FILE}")"
sed "${@}"
NEW="$(${HASHTOOL} "${FILE}")"

# fail if file was not modified
if [[ ${OLD} == "${NEW}" ]] && ! ${SKIP_ERROR}
then
  echo "Error: sed ${*}" >&2
  exit 1
fi

exit 0
