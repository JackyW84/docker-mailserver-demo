#! /bin/bash

# shellcheck disable=SC2094
# ? This is done to ignore the message "Make sure not to read and write
# ? the same file in the same pipeline", which is a result of ${DATABASE}
# ? being used below. (This disables the message file-wide.)

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

function __usage
{
  printf '%s' "${PURPLE}DELDOVECOTMASTERUSER${RED}(${YELLOW}8${RED})

${ORANGE}NAME${RESET}
    deldovecotmasteruser - delete a dovecot master user

${ORANGE}SYNOPSIS${RESET}
    ./setup.sh dovecot-master del [ OPTIONS ] { <MAIL ADDRESS> [<MAIL ADDRESS>${RED}...${RESET}] ${RED}|${RESET} help }

${ORANGE}DESCRIPTION${RESET}
    Delete a dovecot master user.

${ORANGE}OPTIONS${RESET}
    -h
        Show this help dialogue.

${ORANGE}EXAMPLES${RESET}
    ${LWHITE}./setup.sh dovecot-master del administrator${RESET}
        Delete the dovecot master user called 'administrator'.

    ${LWHITE}./setup.sh dovecot-master del administrator admin${RESET}
        Delete dovecot master users 'administrator' and 'admin'.

${ORANGE}EXIT STATUS${RESET}
    Exit status is 0 if command was successful, and 1 if there was an error.
"
}

function _validate_parameters
{
  [[ -z ${*} ]] && { __usage ; _exit_with_error 'No user specified' ; }
}

function _delete_dovecot_master_accounts
{
  local DATABASE_DOVECOT_MASTERS='/tmp/docker-mailserver/dovecot-masters.cf'
  [[ -s ${DATABASE_DOVECOT_MASTERS} ]] || exit 0
  _create_lock # Protect config file with lock to avoid race conditions

  for USER in "${@}"
  do
    ERROR=false

    # ${_USER_} must not contain /s and other syntactic characters
    local _USER_=$(_escape "${USER}")

    if [[ -f ${DATABASE_DOVECOT_MASTERS} ]]
    then
      if ! sedfile --strict -i "/^${_USER_}|/d" "${DATABASE_DOVECOT_MASTERS}"
      then
        _log 'error' "'${USER}' couldn't be deleted in '${DATABASE_DOVECOT_MASTERS}'"
        ERROR=true
      fi
    fi

    ${ERROR} && _exit_with_error 'See the messages above.'
  done
}

[[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

shift $((OPTIND-1))

_validate_parameters
_delete_dovecot_master_accounts "${@}"

exit 0
