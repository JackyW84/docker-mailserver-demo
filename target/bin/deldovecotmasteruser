#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

function _main
{
  [[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

  _validate_parameters ${*}
  _delete_accounts_dovecot_master "${@}"
}

function __usage
{
  printf '%s' "${PURPLE}deldovecotmasteruser${RED}(${YELLOW}8${RED})

${ORANGE}USAGE${RESET}
    ./setup.sh dovecot-master del <MASTER ACCOUNT> [<EXTRA MASTER ACCOUNTS> ${RED}...${RESET} ]

${ORANGE}OPTIONS${RESET}
    ${BLUE}Generic Program Information${RESET}
        help       Print the usage information.

${ORANGE}DESCRIPTION${RESET}
    Delete a dovecot-master account.

${ORANGE}EXAMPLES${RESET}
    ${LWHITE}./setup.sh dovecot-master del admin${RESET}
        Delete the dovecot-master account 'admin'.

    ${LWHITE}./setup.sh dovecot-master del admin extra-admin${RESET}
        Delete the two dovecot-master accounts requested.

${ORANGE}EXIT STATUS${RESET}
    Exit status is 0 if command was successful. If wrong arguments are provided
    or arguments contain errors, the script will exit early with exit status 1.

"
}

function _validate_parameters
{
  [[ -z ${*} ]] && { __usage ; _exit_with_error 'No user specified' ; }
}

function _delete_accounts_dovecot_master
{
  local DATABASE_DOVECOT_MASTERS='/tmp/docker-mailserver/dovecot-masters.cf'
  [[ -s ${DATABASE_DOVECOT_MASTERS} ]] || exit 0
  _create_lock # Protect config file with lock to avoid race conditions

  for MAIL_ACCOUNT in "${@}"
  do
    _account_should_already_exist "${MAIL_ACCOUNT}" "${DATABASE_DOVECOT_MASTERS}"

    _account_remove_from_db "${MAIL_ACCOUNT}" "${DATABASE_DOVECOT_MASTERS}" \
      || _exit_with_error "'${MAIL_ACCOUNT}' could not be deleted in '${DATABASE_DOVECOT_MASTERS}'"
  done
}

_main "${@}"
