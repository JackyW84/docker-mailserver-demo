#!/bin/bash
# vim: et ai si ts=2 sts=2 sw=2
EMAIL="$1"
RECIPIENT="$2"

usage() {
  echo "Usage: delalias <alias@domain> <recipient@other>"
}

errex() {
  echo "$@" 1>&2
  exit 1
}

escape() {
  echo "${1//./\\.}"
}

[ -z "$EMAIL" ] || [ -z "$RECIPIENT" ]  && { usage; errex "No email specifed"; }
if [ -s /var/db/sqlite-mail.db ]; then
  DATABASE=/var/db/sqlite-mail.db
  /usr/bin/sqlite3 $DATABASE "DELETE FROM alias WHERE address='${EMAIL}' AND goto='${RECIPIENT}';"
else
  DATABASE=${DATABASE:-/tmp/docker-mailserver/postfix-virtual.cf}
  [ -s "$DATABASE" ] || exit 0
  #CNT=$(grep "^$EMAIL" $DATABASE | wc -w | awk '{print $1}')
  sed -i -e "/^$EMAIL *$RECIPIENT$/d" \
         -e "/^$EMAIL/s/,$RECIPIENT//g" \
         -e "/^$EMAIL/s/$RECIPIENT,//g" $DATABASE
fi
