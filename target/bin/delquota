#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

function __usage { echo 'Usage: delquota <username@domain>' ; }

function _validate_parameter_user
{
  local DATABASE_ACCOUNTS='/tmp/docker-mailserver/postfix-accounts.cf'

  [[ -z ${MAIL_ACCOUNT} ]] && { __usage ; _exit_with_error "No username specified" ; }
  [[ ${MAIL_ACCOUNT} =~ .*\@.* ]] || { __usage ; _exit_with_error "Username must include the domain" ; }

  grep -qE "^${MAIL_ACCOUNT}\|" "${DATABASE_ACCOUNTS}" || _exit_with_error "User '${MAIL_ACCOUNT}' does not exist"
}

function _remove_quota_for_user
{
  local DATABASE_QUOTA='/tmp/docker-mailserver/dovecot-quotas.cf'

  [[ -s ${DATABASE_QUOTA} ]] || exit 0

  sed -i -e "/^${MAIL_ACCOUNT}:.*$/d" "${DATABASE_QUOTA}"
}

[[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

MAIL_ACCOUNT="${1}"

_validate_parameter_user
_remove_quota_for_user
