#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

function _main
{
  [[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

  local DOMAIN="${1}"
  local MAIL_ACCOUNT="${2}"
  local PASSWD="${3}"

  _validate_parameters
  _add_sasl_password
}

function __usage { echo "Usage: addsaslpassword <domain> <MAIL ACCOUNT> <password>" ; }

function _validate_parameters
{
  [[ -z ${DOMAIN} ]] && { __usage ; _exit_with_error 'No domain specified' ; }
  [[ -z ${MAIL_ACCOUNT} ]] && { __usage ; _exit_with_error 'No username specified' ; }

  if [[ -z ${PASSWD} ]]
  then
    read -r -s -p "Enter Password: " PASSWD
    echo
    [[ -z ${PASSWD} ]] && _exit_with_error 'Password must not be empty'
  fi
}

function _add_sasl_password
{
  local DATABASE_PASSWD='/tmp/docker-mailserver/postfix-sasl-password.cf'

  if grep -qi "^@${DOMAIN}" "${DATABASE_PASSWD}" 2>/dev/null
  then
    sed -i \
      "s|^@${DOMAIN}.*|@${DOMAIN}\t\t${MAIL_ACCOUNT}:${PASSWD}|" \
      "${DATABASE_PASSWD}"
  else
    echo -e "@${DOMAIN}\t\t${MAIL_ACCOUNT}:${PASSWD}" >>"${DATABASE_PASSWD}"
  fi
}

_main "${@}"
