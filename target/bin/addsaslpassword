#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

function _main
{
  [[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

  local DOMAIN="${1}"
  local MAIL_ACCOUNT="${2}"
  local PASSWD="${3}"

  _validate_parameters
  _add_sasl_password
}

function __usage { echo "Usage: addsaslpassword <domain> <MAIL ACCOUNT> <password>" ; }

function _validate_parameters
{
  [[ -z ${DOMAIN} ]] && { __usage ; _exit_with_error 'No domain specified' ; }
  [[ -z ${MAIL_ACCOUNT} ]] && { __usage ; _exit_with_error 'No username specified' ; }

  if [[ -z ${PASSWD} ]]
  then
    read -r -s -p "Enter Password: " PASSWD
    echo
    [[ -z ${PASSWD} ]] && _exit_with_error 'Password must not be empty'
  fi
}

# Config is for sender dependent relay-host auth,
# current support restricts senders to domain scope.
function _add_sasl_password
{
  local SENDER="@${DOMAIN}"
  local RELAY_HOST_ENTRY_AUTH="${SENDER}\t\t${MAIL_ACCOUNT}:${PASSWD}"

  local DATABASE_PASSWD='/tmp/docker-mailserver/postfix-sasl-password.cf'
  # Replace entry for an existing sender, or add new one:
  if grep -qi "^${SENDER}" "${DATABASE_PASSWD}" 2>/dev/null
  then
    sed -i \
      "s|^${SENDER}.*|${RELAY_HOST_ENTRY_AUTH}|" \
      "${DATABASE_PASSWD}"
  else
    echo -e "${RELAY_HOST_ENTRY_AUTH}" >>"${DATABASE_PASSWD}"
  fi
}

_main "${@}"
