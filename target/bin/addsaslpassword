#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

source ./common/helper.sh

function _main
{
  [[ ${1:-} == 'help' ]] && { __usage ; exit 0 ; }

  local DOMAIN="${1}"
  local MAIL_ACCOUNT="${2}"
  shift 2
  local PASSWD="${*}"

  _validate_parameters
  _add_sasl_password
}

function __usage { echo "Usage: addsaslpassword <domain> <MAIL ACCOUNT> <password>" ; }

function _validate_parameters
{
  _arg_expect_domain
  _arg_expect_mail_account
  _password_request_if_missing
}

# Config is for sender dependent relay-host auth,
# current support restricts senders to domain scope.
function _add_sasl_password
{
  local SENDER="@${DOMAIN}"
  local RELAY_HOST_ENTRY_AUTH="${SENDER}\t\t${MAIL_ACCOUNT}:${PASSWD}"
  local DATABASE_PASSWD='/tmp/docker-mailserver/postfix-sasl-password.cf'

  _db_add_or_replace_entry "${SENDER}" "${RELAY_HOST_ENTRY_AUTH}" "${DATABASE_PASSWD}"
}

_main "${@}"
