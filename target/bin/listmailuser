#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh

source ./common/quota.sh
source ./common/virtual-aliases.sh

# suppress error output, e.g. when listmailuser runs in a fresh container (DMS not running)
# shellcheck source=/dev/null
source /etc/dms-settings 2>/dev/null

function _main
{
  local DATABASE_ACCOUNTS='/tmp/docker-mailserver/postfix-accounts.cf'

  [[ -f ${DATABASE_ACCOUNTS} ]] || _exit_with_error "No 'postfix-accounts.cf' file"
  [[ -s ${DATABASE_ACCOUNTS} ]] || _exit_with_error "Empty 'postfix-accounts.cf' - no accounts have been added"

  _list_accounts
}

function _list_accounts
{
  while read -r LINE
  do
    local MAIL_ACCOUNT=$(echo "${LINE}" | cut -d'|' -f1)
    local ACCOUNT_ENTRY="${MAIL_ACCOUNT}"

    local WITH_QUOTA=$(_quota_show_for "${MAIL_ACCOUNT}")
    [[ -n ${WITH_QUOTA} ]] && ACCOUNT_ENTRY+=" ${WITH_QUOTA}"

    local WITH_ALIASES=$(_alias_list_for_account "${MAIL_ACCOUNT}")
    [[ -n ${WITH_ALIASES} ]] && ACCOUNT_ENTRY+="\n    [ aliases -> ${WITH_ALIASES} ]"

    echo -e "* ${ACCOUNT_ENTRY}\n"
  done < <(_get_valid_lines_from_file "${DATABASE_ACCOUNTS}")
}

_main
