#! /bin/bash

# shellcheck source=../scripts/helpers/index.sh
source /usr/local/bin/helpers/index.sh
source ./common/helper.sh

# suppress error output, e.g. when listmailuser runs in a fresh container (DMS not running)
# shellcheck source=/dev/null
source /etc/dms-settings 2>/dev/null

function _main
{
  local DATABASE_ACCOUNTS='/tmp/docker-mailserver/postfix-accounts.cf'
  _list_entries "${DATABASE_ACCOUNTS}"
}

# Used by `_list_entries`:
source ./common/quota.sh
source ./common/virtual-aliases.sh
function _list_format_entry
{
  local LINE=${1}

  local MAIL_ACCOUNT
  MAIL_ACCOUNT=$(echo "${LINE}" | cut -d'|' -f1)

  local WITH_QUOTA
  WITH_QUOTA=$(_quota_show_for "${MAIL_ACCOUNT}")

  local WITH_ALIASES
  WITH_ALIASES=$(_alias_list_for_account "${MAIL_ACCOUNT}")

  local ACCOUNT_ENTRY="${MAIL_ACCOUNT}"
  [[ -n ${WITH_QUOTA}   ]] && ACCOUNT_ENTRY+=" ${WITH_QUOTA}"
  [[ -n ${WITH_ALIASES} ]] && ACCOUNT_ENTRY+="\n    [ aliases -> ${WITH_ALIASES} ]"

  echo "${ACCOUNT_ENTRY}"
}

_main
